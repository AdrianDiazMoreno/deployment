# vim: set ft=sh sw=2 ts=8 et :
deploy_reqmgr_deps()
{
  deploy backend
  deploy wmcore-auth
  deploy couchdb
}

deploy_reqmgr_prep()
{
  mkproj
}

deploy_reqmgr_sw()
{
  deploy_pkg -a reqmgr/ReqMgrSecrets.py comp cms+reqmgr WMCORE_0_6_9
}

deploy_reqmgr_post()
{
  case $host in vocms53 ) disable ;; * ) enable ;; esac
  (mkcrontab; sysboot) | crontab -

  # Tell couchdb to pick up reqmgr on the next restart
  # and configure replication, compaction and backup, too
  local couchdb_config=$root/current/config/couchdb
  local couchdb_state=$root/state/couchdb
  local hour=0

  for area in compaction stagingarea replication backup; do
    rm -f $couchdb_state/$area/reqmgr
    touch $couchdb_state/$area/reqmgr
  done

  for db in reqmgr_config_cache reqmgr_spec_cache; do
    echo "couchapp push $root/current/apps/reqmgr/$db http://localhost:5984/$db" >> $couchdb_state/stagingarea/reqmgr
    echo "1 $hour * * * $couchdb_config/manage compact $db" >> $couchdb_state/compaction/reqmgr
    hour=$(( $hour + 1 ))
  done
}

deploy_reqmgr_auth()
{
  echo 'connectUrl = "oracle://FOO:BAR@ZOINKS"'
}
